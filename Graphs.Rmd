---
title: "Graphs2"
author: "VF"
date: "March-Dec 2020"
output: html_document
---
# Graphs
```{r init}
knitr::opts_chunk$set(echo = TRUE)  # only do this in Rstudio
```
```{r load the data, include=FALSE, echo=FALSE}
verbose <- 1
message(Sys.time())
source("loadData.R")  
```

## From 2021-03-01 until now
Graph and save lots of graphs on all regions present, paginated by size of the Covid impact (total confirmed cases), and on each page, territory graphs are sorted by decreasing value of the first graphed variable on the latest date in that territory.

JHH Graphs. 
```{r echo=FALSE}
message(Sys.time())
message(myGraphNrs)
if (exists("timJ2021")) print("doing things from 202101 -> now, last time this took" % % timJ2021)
tim = Sys.time()
walkThrough( lpdf = JHH,  graphList = myGraphNrs[7:14], 
             #regions = JHH.Regios[12:14],#$Europe,
             myFolderDate  = 'current', from = "2021/01/01",
             slope = FALSE, sortVar = "active_imputed")
timJ2021 <- reportDiffTime('JHH graphs',tim,units = 'mins')
timJ2021
```
## From 2020-01-01 until now
Graph and save lots of graphs on all regions present, paginated by size of the Covid impact (total confirmed cases), and on each page, territory graphs are sorted by decreasing value of the first graphed variable on the latest date in that territory.

JHH Graphs. 
```{r echo=FALSE}
message(Sys.time())
message(myGraphNrs)
if (exists("timJ")) print("last time this took" % % timJ)
tim = Sys.time()
walkThrough( lpdf = JHH,  graphList = myGraphNrs[1:14]
             , regions = JHH.Regios$`JHH Europe1`,
             myFolderDate  = '2020-now')
timJ <- reportDiffTime('JHH graphs',tim,units = 'mins')
timJ
```
This needs speeding up. 
```{r with log extreemely slow: an hour per graph at least. }
walkThrough(JHH, graphList = "graphfcd_fiMnyl", 
   regions = 
     (JHH %>% makeDynRegions(byVar = "people_fully_vaccinated_p_M", piecename = "World"))[1:4],
            myFolderDate = "current", from = '2021/01/01', logy="log2")#, sortVar = "people_fully_vaccinated_p_M")
```

ECDC graphs. Note: since they changed format, this doesnt work anymore. need to read in the data otherwise. 
```{r ECDC graphs walkthrough, include=FALSE, echo=FALSE}
#verbose <- 4
if (verbose >= 1) message("results of" % % Sys.Date())
if ( weekdays( Sys.Date() , abbreviate = FALSE) == "Thursday") { 
  #do this only on thursdays after 12noon when ECDC published. 
  if (exists("timE")) print("last time this took" % % timE)
  tim = Sys.time()
  walkThrough(lpdf = ECDC,regions = ECDC.Regios, graphlist = myGraphNrs,  smoothn=1, myFolderDate  = 'current') 
  timE <- reportDiffTime('ECDC graphs',tim, units = 'mins')
}
```
```{r}
timJ
```
## Covid19 Development during last month only.
```{r one month, include=FALSE, eval=FALSE}

lastmonth <- (Sys.Date() %m-% months(1))
yearmo <- year(lastmonth)%-%sprintf("%02d", month(lastmonth))
if (!dir.exists(myPlotPath%//%yearmo)) {#uses lubridate
  walkThrough(lpdf = JHH, regions = JHH.Regios, graphlist = myGraphNrs, 
              from = floor_date(lastmonth, 'month'), 
              to = ceiling_date(lastmonth, 'month')-1, 
              myFolderDate = yearmo)
  walkThrough(lpdf = ECDC, graphlist = myGraphNrs, 
              from = floor_date(lastmonth, 'month'), 
              to = ceiling_date(lastmonth, 'month')-1, 
              myFolderDate = yearmo)
  }
```

## Do all months up to today
```{r all months, include=FALSE, eval=FALSE}
verbose = 1
makeHistoryGraphs(JHH, regions = JHH.Regios, fromDates = seq(as.Date('2020-01-01'),Sys.Date(),  by = '1 month'))  
makeHistoryGraphs(ECDC, regions = ECDC.Regios, fromDates = seq(as.Date('2020-01-01'),Sys.Date(),  by = '1 month'))  

```
#### A more convoluted way, just for the record: 
```{r all months convoluted, include=FALSE, eval=FALSE}
startDate = "2020-01-01"
fromDates <- as.character(seq(as.Date(startDate), length = 12, by = "1 month"))
toDates <- as.character(seq(as.Date(fromDates[2]), length = 12, by = "1 month") - 1)

makeHistoryGraphs(ECDC,ECDC.Regios, graphlist = myGraphNrs, 
                  fromDates = fromDates, toDates = toDates)

makeHistoryGraphs(JHH,JHH.Regios, graphlist = myGraphNrs, 
                  fromDates = fromDates, toDates = toDates)

```
## This do once in a while, to do all the non-numbererd graphs. 

```{r byDate once a week}
if ( weekdays( Sys.Date() , abbreviate = FALSE) == "Friday")  
  walkThrough(JHH, JHH.Regios[1:10], graphlist = myGraphListbyDate,
              myFolderDate = 'weekly')
```

## Simulations 

Simulate how the non-social distancing situation would have turned out: deaths, recovered, and confirmed   
```{r sims, include=FALSE, eval=FALSE}
graphDddp_fyl(JHH,regios$Vincent,savename  = "deaths missed") 
walkThrough(JHH, regions = JHH.Regios,graphlist = 'graphDccprr_fyl')

walkThrough(ECDC, ECDC.Regios,ext = '_sim', graphlist = c('graphDccprr_fiyl','graphDddp_fyl')) 
```
Simulate how the current state would turn out if no policy nor behavior change
```{r}
walkThrough(ECDC , ECDC.Regios,ext = '_endsim',graphlist = c('graphDccprr_fiyl', 'graphDddp_fyl')) 
```
## R Markdown and Jupyter Notebook: sync with Jupytext. 

This is an R Markdown document, linked to the same document as Jupyter notebook, using Jupytext. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Note that the `{r, echo = FALSE}` parameter can be added to the code chunk to prevent printing of the R code that generated the plot. And Include = false prevents automatic execution of the block.

Second, note that for git, the ipynb and Rmd files containing output are much heavier than the R files which contain the inputs only, according to Jupytext faq (https://jupytext.readthedocs.io/en/latest/faq.html). I commit R and Rmd just to be sure at this moment, and if we want to use Binder we would need to version the IpyNB version. This is only useful for working versions, i.e. the master branch. Here is the latest working master version: [![Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/vinnief/Covid/wip?filepath=graphs.ipynb)

