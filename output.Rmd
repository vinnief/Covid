# Daily and Monthly Output
author: "Vincent Feltkamp"
output: html_document

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
R.Version()$version.string
```
Resulting graphs and cleaned and prepared data can be found at 
https://drive.google.com/drive/folders/1Yo0IW4awCIvWMP6jYVKpn3kLgEolse0e?usp=sharing
## for publication 
```{r , echo=FALSE}
deprecated. don't run this unless next one does not work
#rm(list = setdiff(ls(), c('ECDC0', 'JHH0', 'JHH', 'ECDC', 'JHHRegios', 'ECDCRegios','testing')))
options(warn = 0)
if (!exists('JHH')) source('loadData.R') else 
  if (max(JHH$Date) < Sys.Date() - 1) source('loadData.R')  else source('definitions.R')
save.image(".RData") #D:/gits/Covid19/ #save immediately so that another RMD or Jupyter notebook does not need to redownload. 
tibble(maxECDCdate = max(ECDC$Date), maxJHHdate = max(JHH$Date))# % % "is the last Date for ECDC data, and " % % "is max date for JHH data"
```
## load the data
```{r initialize}
source("loadData.R")
```
# Jupyter Plot options. 
```{r extra wide, eval = FALSE}
options( repr.plot.width = 6,repr.plot.res = 300)# repr.plot.height = 3)#, repr.plot.res = 200)
```
```{r middle wide, eval = FALSE}
options( repr.plot.width = 5,repr.plot.res = 200)# repr.plot.height = 3)#, repr.plot.res = 200)
```

## Graph active_imputed, recovered, deaths, and confirmed for some selected territories, 
based on JHH data:
```{r demo graph}
graphit(JHH, regios$Vincent, xvar = 'Date', 
        yvars = c('net_active_imputed','new_recovered','new_deaths','new_confirmed'),
        facet = "PSCR", logy = TRUE,from = "2020-09-01")
```

## test the new labeling of endpoints

```{r test labels}
source("graphit.R") 
graphit(JHH, regios$Vincent, xvar = 'day', logx =  FALSE , logy = TRUE, from = "2020-08-01",
          yvars = c('new_confirmed_p_M'), labmeth = 'repel_label', putlegend = FALSE)
graphit(JHH, regios$Vincent, xvar = 'day', logx =    FALSE, logy = TRUE, from = "2020-08-01",
          yvars = c('new_confirmed_p_M'), labmeth = 'repel_text')
graphit(JHH, regios$Vincent, xvar = 'day', logx =    FALSE, logy = TRUE, from = "2020-08-01",
          yvars = c('new_confirmed_p_M'), labmeth = 'dl_polygon')
graphit(JHH, regios$Vincent, xvar = 'day', logx =    FALSE, logy = TRUE, from = "2020-08-01",
          yvars = c('new_confirmed_p_M'), labmeth = 'dl_bumpup', putlegend = TRUE)
```

## Descriptive stats
### fastest growth
```{r latest numbers with most growth}
JHH %>% filter(Date == max(Date)) %>% filter(!is.nan(new_active_rate)) %>%
  select(PSCR,confirmed, active_imputed, deaths, new_confirmed, new_active_rate, active_imputed_growthRate, 
         active_imputed_p_M) %>% arrange(new_active_rate) %>% tail(10)
```
### Interesting Countries latest numbers: 
```{r}
JHH[JHH$Date == max(JHH$Date) & JHH$PSCR %in% 
      c('EU','World',"Kazakhstan",'Belgium','Spain','US','Netherlands','Europe',
        'Germany','France','Africa','Russia','Brazil'),
    c('PSCR','active_imputed','active_imputed_p_M','new_deaths','new_confirmed',
      'new_active_rate', 'active_imputed_growthRate','confirmed') ]  %>%
  arrange(new_active_rate)

```
### Who overtakes us based the JHH data set on latest day? 
```{r overtaking 1, include=FALSE, eval=FALSE}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),
        function(x) overtakeDays_df(JHH,x,who = 'theyme',lastDays = 1))
```
### Who overtakes, in 7 day averages averages according to the JHH? 
```{r overtaking week based}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),
        function(x) overtakeDays_df(JHH,x,who = 'theyme',lastDays = 7))
```

### Who overtakes, in 7 day averages according to the ECDC? 
```{r overtaking based on ECDC}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'), 
        function(x) overtakeDays_df(ECDC,x,who = 'theyme',lastDays = 7))
```
### Who is more affected among Kz, S, Nl, Be? 
```{r graph it}
graph3Dard_fia(ECDC, c('Kazakhstan','Belgium','Netherlands','Sweden'))
graph3Dard_fina(ECDC, c('Kazakhstan','Belgium','Netherlands','Sweden'))
```
### Who do Kz, Nl, S, Be overtake?
```{r we overtake}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(JHH,x,who = 'Ithem',lastDays = 7))
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(ECDC,x,who = 'Ithem',lastDays = 7))
```
### Who overtakes the UK, France, or Germany soon: 
```{r}
options( repr.plot.width = 5, repr.plot.height = 3, repr.plot.res = 200)# repr.plot.height = 3)#, repr.plot.res = 200)
```

### How are UK, France & Germany doing? 
```{r }
graph3Dard_fia(JHH, c('Germany','France','United Kingdom'))
graph3Dard_fina(JHH, c('Germany','France','United Kingdom'))
map_dfc(c('Germany','France','United Kingdom'), function(x) overtakeDays_df(JHH,x,who = "theyme", lastDays = 7))
map_dfc(c('Germany','France','United Kingdom'), function(x) overtakeDays_df(JHH,x,who = "Ithem", lastDays = 7))
```
Note: Not overtaking anyone does not mean the epidemic is under control. It just means your epidemic is alsready larger than all states that grow slower. It also means you have better control than more severely touched territories. 
### State of New York state, Indonesia, Peru, India: 
```{r NY Id In Pe}
graph3Dard_fina(JHH, c('New York,US','California,US','Florida,US','Texas,US','Peru',"Arizona,US"))
map_dfc(c('New York,US','California,US','Florida,US','Texas,US','Peru',"Arizona,US"),
        function(x) overtakeDays_df(JHH,x,who = 'Ithem'))
map_dfc(c('New York,US','California,US','Florida,US','Texas,US','Peru',"Arizona,US"),
        function(x) overtakeDays_df(JHH,x,who = 'theyme'))
```
### The most affected regions in the world 
(pop the graph out to a new window in Rstudio and enlarge to see more detail)
```{r most affected graph}
graph6Dardcra_finyl(JHH, JHHRegios$`JHH World1`)
```
```{r deaths and recovered by confirmed}
graph2crd_il(JHH,JHHRegios$`JHH Europe3`)
graph2crd_il(JHH,JHHRegios$`JHH Europe2`)
graph1dnar_iyl(JHH, JHHRegios$`JHH Europe2`)
 graphit(JHH, JHHRegios$`JHH Europe2`, minVal=1, xvar = 'day', 
          yvars = c('new_active_rate'), logy = TRUE, intercept = stableRate) 
```
Note: the motor in all this is the graphit function. It is quite powerful but has a lot of parameters. Several functions preset some parameters, Below a list of Graphs defined. 
```{r show the system}
setdiff(myGraphList, c(myGraphListbyDate, myGraphListbyDay, myGraphNrs))
myGraphListbyDate #that don't get a number. This because then they do not get executed every day
myGraphListbyDay 
myGraphNrs
```
There is a system in the naming: 
```{r}
graphCodes()
```
