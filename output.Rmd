---
title: "Graphs"
author: "VF"
date: "9 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Resulting graphs and cleaned and prepared data can be found at 
# https://drive.google.com/drive/folders/1Yo0IW4awCIvWMP6jYVKpn3kLgEolse0e?usp=sharing
#for publication 
```{r cleanup and redefinition}
rm(list = setdiff(ls(), c('ECDC0', 'JHH0', 'JHH', 'ECDC', 'JHHRegios', 'ECDCRegios','testing')))
options(warn = 0)
source("loadData.R")  #also loads the requirements and the definitions 
```
Graph active_imputed, recovered, deaths, and confirmed for some selected territories, 
based on JHH data:
```{r demo graph}
graphit(JHH, regios$Vincent, xvar = 'Date', 
        yvars = c('active_imputed','recovered_imputed', 'deaths','confirmed'),
        facet = "PSCR", logy = TRUE)
```
Show table outputs: 
```{r}
#show some data table output
#latest numbers
JHH[JHH$Date == max(JHH$Date),'Date'][1,1]
JHH %>% filter(Date == max(Date)) %>% filter(!is.nan(new_active_rate)) %>%
  select(PSCR,confirmed, active_imputed, deaths, new_confirmed, new_active_rate, active_imputed_growthRate, 
         active_imputed_p_M) %>% arrange(new_active_rate) %>% tail(10)
JHH[JHH$Date == max(JHH$Date) & JHH$PSCR %in% 
      c('EU','World','New York,US',"Kazakhstan",'Belgium','Spain','US','Netherlands','Europe',
        'Germany','France','Africa','Iran','Russia','Brazil'),
    c('PSCR','confirmed','active_imputed','deaths','new_confirmed',
      'new_active_rate', 'active_imputed_growthRate','active_imputed_p_M') ]  %>%
  arrange(new_active_rate)

```
Who overtakes us based on 7 day averages in the JHH data set? 
```{r}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(JHH,x,who = 'theyme',lastDays = 7))
```
And on latest day data? 
```{r} 
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(JHH,x,who = 'theyme',lastDays = 1))
```
and according to ECDC? 
```{r}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(ECDC,x,who = 'theyme',lastDays = 7))
```
Who do we overtake?
```{r}
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(JHH,x,who = 'Ithem',lastDays = 7))
map_dfc(c('Kazakhstan','Belgium','Netherlands','Sweden'),function(x) overtakeDays_df(ECDC,x,who = 'Ithem',lastDays = 7))
```
Some other countries now: 
```{r}
map_dfc(c('Germany','France','United Kingdom'), function(x) overtakeDays_df(JHH,x,who = "theyme", lastDays = 4))
map_dfc(c('New York,US','Indonesia','Peru','India'),function(x) overtakeDays_df(JHH,x,who = 'Ithem'))
map_dfc(c('New York,US','Indonesia','Peru','India'),function(x) overtakeDays_df(JHH,x,who = 'theyme'))
```

if you want to write the data to disk, make sure to define the datapath so that R can write to it
``` {r}
dataPath <- './data'
if (!dir.exists(datapath)) dir.create(datapath, recursive = TRUE)
writeWithCounters(ECDC,name = "Covid19ECDC")
writeWithCounters(JHH,name = "Covid19JHH") 
```
check what graphs are defined 
```{r}
graphCodes()
myGraphListbyDate
myGraphListbyDay
myGraphNrs
myGraphList

verbose = 2
```
look at growth rates and growth paths in first days (Synchronized)
walkThrough(ECDC,regions = ECDCRegios,graphlist = c("graph1dnr_iyl","graph2dac_iyl"))

simulate deaths and confirmed   
```{r}
walkThrough(ECDC, ECDCRegios,ext = '_sim', graphlist = c('graphDccprr_fiyl','graphDddp_fyl'))  #sims
walkThrough(ECDC , ECDCRegios,ext = '_endsim',graphlist = c('graphDccprr_fiyl','graphDddp_fyl')) #simulations 
graphDddp_fyl(JHH,regios$Vincent,savename  = "deaths missed") 

if ( weekdays( Sys.Date() , abbreviate = FALSE) == "Friday")   walkThrough(ECDC, ECDCRegios, graphlist = myGraphListbyDate)

JHH %>% walkThrough(regions = JHHRegios,graphlist = 'graphDccprr_fyl')
JHH %>% walkThrough(regions = JHHRegios[1:2],graphlist = 'graphDccprr_fyl')
  #walkThrough(JHH, regions=JHHRegios[1:2],graphlist = 'graphDccprr_fyl')
```


do all months
```{r}
verbose = 1

makeHistoryGraphs(JHH, regions = JHHRegios, fromDates = seq(as.Date('2020-01-01'),Sys.Date(),  by = '1 month'), ordre = 'GR')  
makeHistoryGraphs(ECDC, regions = ECDCRegios, fromDates = seq(as.Date('2020-01-01'),Sys.Date(),  by = '1 month'))  
startDate = "2020-01-01"
fromDates <- as.character(seq(as.Date(startDate), length = 12, by = "1 month"))
toDates <- as.character(seq(as.Date(fromDates[2]), length = 12, by = "1 month") - 1)

makeHistoryGraphs(ECDC,ECDCRegios, graphlist = myGraphNrs, 
                  fromDates = fromDates, toDates = toDates)

makeHistoryGraphs(JHH,JHHRegios, graphlist = myGraphNrs, 
                  fromDates = fromDates, toDates = toDates)

```
